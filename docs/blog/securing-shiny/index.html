<!DOCTYPE html><html class="theme-bubblegum" lang="en" data-astro-cid-scuu7fyy> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Blogster"><meta name="theme-color" content="#ffffff"><!-- 
  This is an example. 
  Use https://realfavicongenerator.net to generate the icons and manifest. 
--><link href="/favicon.ico" rel="shortcut icon"><!-- Primary Meta Tags --><title>Securing Shiny: Safeguarding Links and Downloads</title><meta name="title" content="Securing Shiny: Safeguarding Links and Downloads"><meta name="description" content="Discover essential tips for ensuring the safety of downloadable links in Shiny apps"><!-- Open Graph / Facebook --><meta property="og:title" content="Securing Shiny: Safeguarding Links and Downloads"><meta property="og:description" content="Discover essential tips for ensuring the safety of downloadable links in Shiny apps"><meta property="og:type" content="article"><meta property="og:url" content="https://filipakkad.com/blog/securing-shiny"><meta property="article:author" content="Filip Akkad"><meta property="article:published_time" content="2024-01-01T00:00:00.000Z"><!-- Twitter --><meta property="twitter:title" content="Securing Shiny: Safeguarding Links and Downloads"><meta property="twitter:description" content="Discover essential tips for ensuring the safety of downloadable links in Shiny apps"><meta property="twitter:site" content="@yourtwitterhandle"><meta property="twitter:creator" content="@yourtwitterhandle"><meta property="twitter:card" content="summary_large_image"><!-- {twitter.url && <meta property="twitter:url" content={twitter.url} />} --><!-- 
    We don't want to use <link /> to load fonts from Google CDN 
    but if you want to switch font this is the easiest way 
    to check how your page will look with the new font.
--><!-- 
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;0,700;0,800;1,400;1,700&display=block"
        rel="stylesheet"
    />
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;0,800;1,400&display=swap"
        rel="stylesheet"
    />
--><link rel="preload" href="/fonts/space-grotesk-v13-latin-regular.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><link rel="preload" href="/fonts/space-grotesk-v13-latin-700.woff2" as="font" type="font/woff2" crossorigin="crossorigin"><style>
    /* space-grotesk-regular - latin */
    @font-face {
      font-family: "Space Grotesk";
      font-style: normal;
      font-weight: 400;
      src: local(""),
        url("/fonts/space-grotesk-v13-latin-regular.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/space-grotesk-v13-latin-regular.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
    /* space-grotesk-700 - latin */
    @font-face {
      font-family: "Space Grotesk";
      font-style: normal;
      font-weight: 700;
      src: local(""),
        url("/fonts/space-grotesk-v13-latin-700.woff2") format("woff2"),
        /* Chrome 26+, Opera 23+, Firefox 39+ */
          url("/fonts/space-grotesk-v13-latin-700.woff") format("woff"); /* Chrome 6+, Firefox 3.6+, IE 9+, Safari 5.1+ */
    }
  </style><script>
  // figure out user's preferred theme and set it as html class for tailwind before paint
  (function () {
    if (typeof window !== "undefined") {
      const isSystemColorSchemeDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const storageTheme = sessionStorage.getItem("theme");
      if (!storageTheme && isSystemColorSchemeDark) {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#0f172a";
      } else if (storageTheme === "dark") {
        document.documentElement.classList.add("dark");
        document.head.children.namedItem("theme-color").content = "#0f172a";
      } else {
        // we already server render light theme
        document.head.children.namedItem("theme-color").content = "#ffffff";
      }
    }
  })();
</script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }

  // global function so that it can be called from anywhere
  // Updates consent for GA4 to granted if called
  window.consentGranted = function () {
    console.log("consent granted");
    gtag("consent", "update", {
      ad_storage: "granted",
      analytics_storage: "granted",
      functionality_storage: "granted",
      personalization_storage: "granted",
      security_storage: "granted",
    });
  };

  // Returns value of a cookie named 'cookie-consent'
  // Should be either "granted" or "denied"
  window.getCookieConsent = function () {
    try {
      const consent = document.cookie.match(/cookie-consent=([^;]+)/)[1];
      return consent;
    } catch (error) {
      return "unk";
    }
  };

  if (window.getCookieConsent() == "granted") {
    // If cookies already approved, set that
    console.log("default set to granted");
    gtag("consent", "default", {
      ad_storage: "granted",
      analytics_storage: "granted",
      functionality_storage: "granted",
      personalization_storage: "granted",
      security_storage: "granted",
    });
  } else {
    // default all to 'denied'.
    console.log("default set to denied");
    gtag("consent", "default", {
      ad_storage: "denied",
      analytics_storage: "denied",
      functionality_storage: "denied",
      personalization_storage: "denied",
      security_storage: "denied",
    });
  }
</script> <!-- Google Tag Manager --><script>
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({
      'gtm.start':
        new Date().getTime(), event: 'gtm.js'
    });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
    j.async = true;
    j.src =
      'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, 'script', 'dataLayer', 'GTM-PPLN2DMJ');
</script><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var i=t=>{let e=async()=>{await(await t())()};"requestIdleCallback"in window?window.requestIdleCallback(e):setTimeout(e,200)};(self.Astro||(self.Astro={})).idle=i;window.dispatchEvent(new Event("astro:idle"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><astro-island uid="5NQRz" prefix="r0" component-url="/assets/CookieConsent.wm8rc1Nz.js" component-export="CookieConsent" renderer-url="/assets/client.olTvLX7Y.js" props="{&quot;data-astro-cid-scuu7fyy&quot;:[0,true]}" ssr="" client="idle" opts="{&quot;name&quot;:&quot;CookieConsent&quot;,&quot;value&quot;:true}"></astro-island><link rel="stylesheet" href="/assets/asset.A3wsXWv2.css" />
<link rel="stylesheet" href="/assets/asset.fkfMP9If.css" />
<style>body{display:grid;grid-template-areas:"header" "main" "footer";grid-template-rows:5rem minmax(0,1fr) 5rem;grid-template-columns:minmax(0,1fr)}main[data-astro-cid-scuu7fyy]{grid-area:main}
</style><script type="module" src="/assets/hoisted.Xr5iWCN_.js"></script></head> <body class="max-w-3xl mx-auto min-h-screen px-6 sm:px-8" data-astro-cid-scuu7fyy> <!-- Google Tag Manager (noscript) --> <noscript> <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PPLN2DMJ" height="0" width="0" style="display:none;visibility:hidden" data-astro-cid-scuu7fyy>
    </iframe> </noscript> <!-- End Google Tag Manager (noscript) --> <header class="flex justify-between fixed w-full left-0 items-center backdrop-blur h-16 z-10" data-astro-cid-3ef6ksr2> <div class="flex justify-between mx-auto px-6 sm:px-8 w-full items-center  max-w-3xl" data-astro-cid-3ef6ksr2> <div class="w-fit" data-astro-cid-3ef6ksr2> <nav class="hidden md:flex w-fit" data-astro-cid-dmqpwcec><section class="text-text-bold w-fit" data-astro-cid-dmqpwcec><ul class="unset flex gap-4 [&>li]:p-0 w-fit" data-astro-cid-dmqpwcec><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/" class="unset animated-link" data-astro-cid-dmqpwcec>About me</a></li><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/blog" class="show unset animated-link" data-astro-cid-dmqpwcec>Blog</a></li><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/contact" class="unset animated-link" data-astro-cid-dmqpwcec>Contact</a></li></ul></section></nav><nav class="md:hidden" data-astro-cid-dmqpwcec><button id="mobile-menu-open" data-astro-cid-dmqpwcec><i class="fa-solid fa-bars" aria-hidden="true" title="Open mobile menu" data-astro-cid-dmqpwcec></i><span class="fa-sr-only" data-astro-cid-dmqpwcec>Open mobile menu</span></button><section id="mobile-menu" class="hide-menu fixed top-0 left-0 h-[100dvh] z-20 w-full transition-transform bg-black/75 border-primary-blue" data-astro-cid-dmqpwcec><div class="bg-bg-body w-[75%] h-full drop-shadow-2xl" id="mobile-menu-body" data-astro-cid-dmqpwcec><button id="mobile-menu-close" class="px-6 h-[5rem] text-lg xml-[1px]" data-astro-cid-dmqpwcec><i class="fa-solid fa-xmark" aria-hidden="true" title="Close mobile menu" data-astro-cid-dmqpwcec></i><span class="fa-sr-only" data-astro-cid-dmqpwcec>Close mobile menu</span></button><ul class="unset flex flex-col text-text-bold gap-4 [&>li]:p-0 px-6" data-astro-cid-dmqpwcec><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/" class="unset animated-link" data-astro-cid-dmqpwcec>About me</a></li><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/blog" class="show unset animated-link" data-astro-cid-dmqpwcec>Blog</a></li><li data-astro-cid-dmqpwcec><!-- DO NOT FORMAT. IT ADDS AN EXTRA SPACE ON RENDERED CONTENT. --><a href="/contact" class="unset animated-link" data-astro-cid-dmqpwcec>Contact</a></li></ul></div></section></nav> </div> <div class="flex items-center" data-astro-cid-3ef6ksr2> <div class="justify-self-end py-2 flex items-center content-center text-text-bold" data-astro-cid-3ef6ksr2> <a class="unset ml-4 rounded-sm transition-[background-size] duration-150 ease-in-out bg-left-bottom bg-[length:0%_55%] hover:bg-[length:100%_55%] bg-no-repeat bg-gradient-to-r from-primary-yellow to-primary-yellow dark:bg-none dark:hover:text-primary-yellow" href="https://github.com/filipakkad" target="_blank" data-astro-cid-3ef6ksr2> <i class="fa-brands fa-github" aria-hidden="true" title="Filip on GitHub" data-astro-cid-3ef6ksr2></i> <span class="hidden md:inline" data-astro-cid-3ef6ksr2>GitHub</span> </a> <a class="unset ml-4 rounded-sm transition-[background-size] duration-150 bg-left-bottom bg-[length:0%_55%] hover:bg-[length:100%_55%] bg-no-repeat bg-gradient-to-r from-primary-blue to-primary-blue dark:bg-none dark:hover:text-primary-blue" href="https://linkedin.com/in/filip-akkad/" target="_blank" data-astro-cid-3ef6ksr2> <i class="fa-brands fa-linkedin" aria-hidden="true" title="Filip on LinkedIn" data-astro-cid-3ef6ksr2></i> <span class="hidden md:inline" data-astro-cid-3ef6ksr2>LinkedIn</span> </a> </div> <mode-toggle class="flex" data-astro-cid-tcsrer47> <button class="justify-self-end bg-black dark:bg-white ml-4 inline-flex h-6 w-11 items-center rounded-full" id="mode-toggle" role="switch" type="button" tabindex="0" aria-checked="false" data-headlessui-state="" data-astro-cid-tcsrer47><span class="sr-only" data-astro-cid-tcsrer47>Toggle dark mode</span><span id="mode-circle" class="light inline-block h-4 w-4 rounded-full bg-gradient-to-tr invisible" data-astro-cid-tcsrer47><span class="absolute top-0 right-0 w-[10px] h-[10px] rounded-full bg-gray-700 scale-[0]" data-astro-cid-tcsrer47></span> </span> </button> </mode-toggle>   </div> </div> </header>  <main id="main" data-astro-cid-scuu7fyy> <section class="blog-post prose max-w-none prose-bubblegum" data-astro-cid-scuu7fyy> <div class="flex flex-col gap-2" data-astro-cid-scuu7fyy> <h1 class="m-0 mb-[0.25em] text-3xl sm:text-4xl" data-astro-cid-scuu7fyy> <span class="text-left whitespace-break-spaces
              pl-6 relative block leading-[150%]
              after:absolute after:content-[''] after:w-2 after:h-full after:top-0 after:left-0 after:bg-primary-green
            " data-astro-cid-scuu7fyy> Securing Shiny: Safeguarding Links and Downloads </span> </h1> <div class="flex gap-3 mb-3 items-center"> <div class="h-11 aspect-square rounded-full overflow-hidden"> <img src="/assets/asset.PGwsuqgK_1lJpIL.webp" class="h-full w-full rounded-full m-0 object-cover" alt="Filip's photo" width="150" height="200" loading="lazy" decoding="async"> </div> <div class="flex flex-col gap-1"> <a href="/" class="!bg-none animated-link"><h4 class="m-0 leading-[1]">Filip Akkad</h4></a>  <time class="block text-text-muted text-sm" data-astro-cid-scuu7fyy>Jan 1, 2024</time>  </div> </div> <img src="/assets/asset.ibpSSTME_ZdC68M.webp" alt="banner" class="m-0 mb-4 h-48 object-cover rounded" data-astro-cid-scuu7fyy width="1200" height="630" loading="lazy" decoding="async"> </div> <h2 id="problem-context"><a href="#problem-context">Problem context</a></h2>
<p>A while back, together with my team we were asked to implement a safe way of displaying sensitive PDFs (containing patient’s data) in our pharma Shiny app. Despite operating within the RStudio Connect environment, ensuring the security of these documents demanded extra precautions beyond standard practices.</p>
<h2 id="popular-approach-addresourcepath-unsafe"><a href="#popular-approach-addresourcepath-unsafe">Popular Approach: <code>addResourcePath</code> (unsafe);</a></h2>
<p>The prevailing method involves exposing assets through `addResourcePath“. The example is demonstrated in the code snippet below:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="r" data-theme="github-dark-dimmed">app_1.r (unsafe)</figcaption><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-line-numbers="" data-language="r" data-theme="github-dark-dimmed" style="display: grid;" data-line-numbers-max-digits="2"><span data-line=""><span style="color:#6CB6FF">library</span><span style="color:#ADBAC7">(shiny)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">ui </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> fluidPage</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#F69D50">  uiOutput</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">server</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(input, output, session) {</span></span>
<span data-line=""><span style="color:#F69D50">  addResourcePath</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"assets"</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">"./"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">  output</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">pdf </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> renderUI</span><span style="color:#ADBAC7">({</span></span>
<span data-line=""><span style="color:#768390">    # Fetch the example PDF content from the external link and save it as a temporary file</span></span>
<span data-line=""><span style="color:#ADBAC7">    temp_pdf_path </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> tempfile</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">fileext</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> ".pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    external_pdf_link </span><span style="color:#F47067">&#x3C;-</span><span style="color:#96D0FF"> 'https://www.africau.edu/images/default/sample.pdf'</span></span>
<span data-line=""><span style="color:#6CB6FF">    download.file</span><span style="color:#ADBAC7">(external_pdf_link, temp_pdf_path, </span><span style="color:#F69D50">mode</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "wb"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">    tags</span><span style="color:#F47067">$</span><span style="color:#F69D50">iframe</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">src</span><span style="color:#F47067">=</span><span style="color:#96D0FF">"/assets/sample.pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">  })</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F69D50">shinyApp</span><span style="color:#ADBAC7">(ui, server, </span><span style="color:#F69D50">options</span><span style="color:#F47067"> =</span><span style="color:#F47067"> list</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">port</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> 4444</span><span style="color:#ADBAC7">))</span></span></code></pre></figure>
<p>However, this seemingly straightforward approach harbors inherent security risks.
The issue with the provided code lies in the unrestricted access it grants to the asset once enabled. Even without initiating a new session in Shiny, external users can access the file. For instance, opening the following link in a separate incognito browser tab:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="text" data-theme="github-dark-dimmed"><code data-language="text" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>http://localhost:4444/assets/sample.pdf</span></span></code></pre></figure>
<p>reveals a serious security vulnerability.</p>
<p><img alt="app_1"  src="/assets/asset.TFdSWqN8_Z2aaVSl.webp" width="1140" height="496" loading="lazy" decoding="async"></p>
<h2 id="safer-alternative-endpoint-with-session-token"><a href="#safer-alternative-endpoint-with-session-token">Safer Alternative: Endpoint with Session Token</a></h2>
<p>A more secure approach involves creating a dedicated endpoint within Shiny to serve assets exclusively for specific sessions. This method is commonly employed in functionalities like <code>downloadHandler</code>, albeit hidden beneath the implementation layer.</p>
<p>The example path appears as follows:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="text" data-theme="github-dark-dimmed"><code data-language="text" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>http://localhost:4444/session/55099de85c5bfd2839b87488605c9395/dataobj/example-get-api?w=&#x26;nonce=853efe9753e75378</span></span></code></pre></figure>
<p>One notable feature in this link is the embedded session token, ensuring that the asset is served only for the duration of a specific session.</p>
<p>The following code snippet demonstrates a practical implementation:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="r" data-theme="github-dark-dimmed">app_2.r</figcaption><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-line-numbers="" data-language="r" data-theme="github-dark-dimmed" style="display: grid;" data-line-numbers-max-digits="2"><span data-line=""><span style="color:#6CB6FF">library</span><span style="color:#ADBAC7">(shiny)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">ui </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> fluidPage</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#F69D50">  textOutput</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"link"</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#F69D50">  uiOutput</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">server</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(input, output, session) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  example_get_data_url </span><span style="color:#F47067">&#x3C;-</span><span style="color:#ADBAC7"> session</span><span style="color:#F47067">$</span><span style="color:#F69D50">registerDataObj</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    name</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "example-get-api"</span><span style="color:#ADBAC7">,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    data</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#768390">      # Fetch the example PDF content from the external link and save it as a temporary file</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">      temp_pdf_path </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> tempfile</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">fileext</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> ".pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">      external_pdf_link </span><span style="color:#F47067">&#x3C;-</span><span style="color:#96D0FF"> 'https://www.africau.edu/images/default/sample.pdf'</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">      download.file</span><span style="color:#ADBAC7">(external_pdf_link, temp_pdf_path, </span><span style="color:#F69D50">mode</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "wb"</span><span style="color:#ADBAC7">)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">      readBin</span><span style="color:#ADBAC7">(temp_pdf_path, </span><span style="color:#96D0FF">"raw"</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">file.info</span><span style="color:#ADBAC7">(temp_pdf_path)</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">size)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    },</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">    filterFunc</span><span style="color:#F47067"> =</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(content, req) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">      httpResponse</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">200</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">"application/pdf"</span><span style="color:#ADBAC7">, content)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    }</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""><span style="color:#ADBAC7">  output</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">pdf </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> renderUI</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#ADBAC7">    tags</span><span style="color:#F47067">$</span><span style="color:#F69D50">iframe</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">      src</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> example_get_data_url</span></span>
<span data-line=""><span style="color:#ADBAC7">    )</span></span>
<span data-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">  output</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">link </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> renderText</span><span style="color:#ADBAC7">({</span></span>
<span data-line=""><span style="color:#6CB6FF">    paste0</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_protocol,</span></span>
<span data-line=""><span style="color:#96D0FF">      '//'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_hostname,</span></span>
<span data-line=""><span style="color:#96D0FF">      ':'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_port,</span></span>
<span data-line=""><span style="color:#96D0FF">      '/'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      example_get_data_url</span></span>
<span data-line=""><span style="color:#ADBAC7">    )</span></span>
<span data-line=""><span style="color:#ADBAC7">  })</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F69D50">shinyApp</span><span style="color:#ADBAC7">(ui, server)</span></span></code></pre></figure>
<p>The crucial element here is <code>session$registerDataObj</code>, which registers a new endpoint and efficiently serves the specified data. In this instance, the data is a binary PDF file, and its accessibility is confined to the associated session, thereby enhancing the overall security of the Shiny application.</p>
<h2 id="but"><a href="#but">But..?</a></h2>
<p>Although our PDF delivery mechanism in <code>app_2.r</code> is significantly more secure, there remains a security gap that requires attention.</p>
<p>To demonstrate this, execute the <code>app_2.r</code> script and copy the generated link from the top. Now, open a separate incognito tab and paste the link – voila, the PDF is accessible for an anonymous user. This scenario is far from ideal, especially when dealing with highly sensitive files.</p>
<p><img alt="app_2"  src="/assets/asset.T0kHrb8N_Z1RF1H9.webp" width="1140" height="496" loading="lazy" decoding="async"></p>
<p>As observed, sharing the link (or more precisely, the session token embedded within it) poses a security risk. Session tokens should be considered a secret. What if the link is accidentally shared or falls into the wrong hands? The recipient gains immediate access to the file.
While there are significant mitigators of the risks (see a <a href="https://github.com/rstudio/shiny/issues/3748">discussion</a>) + the link only functioning within the duration of the open session, there is still a room for improvement.👇</p>
<blockquote>
<p><strong>At the time of writing this blog an open PR from Joe Cheng addresses this vulnerability - <a href="https://github.com/rstudio/shiny/pull/3766">PR-3766</a>.</strong></p>
</blockquote>
<p>In the interim, you can explore my app-level implementation designed to tackle this issue. Although this solution may become obsolete once the aforementioned PR is merged, I still consider it a worthwhile experiment to implement it independently. 👇</p>
<hr>
<h2 id="extra-endpoint-with-session-token-and-jwt-token"><a href="#extra-endpoint-with-session-token-and-jwt-token">Extra: Endpoint with Session Token and JWT token</a></h2>
<p>To further enhance security, we need a mechanism that goes beyond the session lifespan and introduces additional layers of authentication.</p>
<p>In other words, we have to provide that browser is the same as the one that initiated the session. To achieve this, we will leverage JSON Web Tokens (JWTs) to create session access tokens.</p>
<p>The general idea is to generate a token for each session and store it in the browser as a cookie. Then, when the user requests the asset, the token is sent to the server, which validates it and serves the asset if the token is valid.
Think of it as a two-factor authentication mechanism, where the session URL is the first factor, and the JWT token is the second factor.</p>
<p>Comparing to <code>app_2.r</code> we need to introduce couple of helper functions first:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#6CB6FF">Sys.setenv</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">SHINY_SALT</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> 'salt&#x26;pepper'</span><span style="color:#ADBAC7">)</span></span></code></pre></figure>
<p>We need to set a salt for the JWT token. The salt is used to generate a unique token for each session. The salt should be a secret and should be different for each Shiny application.</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">generate_session_jwt</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#ADBAC7">    session_token,</span></span>
<span data-line=""><span style="color:#F69D50">    salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">))</span></span>
<span data-line=""><span style="color:#ADBAC7">{</span></span>
<span data-line=""><span style="color:#F69D50">  modified_session_token</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> paste0</span><span style="color:#ADBAC7">(salt, session_token);</span></span>
<span data-line=""><span style="color:#ADBAC7">  key </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> paste0</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'session_'</span><span style="color:#ADBAC7">,</span><span style="color:#6CB6FF">digest</span><span style="color:#F47067">::</span><span style="color:#F69D50">digest</span><span style="color:#ADBAC7">(modified_session_token))</span></span>
<span data-line=""><span style="color:#ADBAC7">  token </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> jose</span><span style="color:#F47067">::</span><span style="color:#F69D50">jwt_encode_hmac</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">secret</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> modified_session_token)</span></span>
<span data-line=""><span style="color:#F47067">  list</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#F69D50">    key</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> key,</span></span>
<span data-line=""><span style="color:#F69D50">    token</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> token</span></span>
<span data-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p><code>generate_session_jwt</code> function generates a JWT token for a given session id. The token is a JWT token, and the key is a unique identifier for the token (in case multiple SHiny sessions are open in one browser). The key is used to store the token in the browser as a cookie. There is no payload needed, we just need to know that the token is valid.</p>
<hr>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">validate_session_jwt</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#ADBAC7">    token,</span></span>
<span data-line=""><span style="color:#ADBAC7">    session_token,</span></span>
<span data-line=""><span style="color:#F69D50">    salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">) {</span></span>
<span data-line=""><span style="color:#6CB6FF">  jose</span><span style="color:#F47067">::</span><span style="color:#F69D50">jwt_decode_hmac</span><span style="color:#ADBAC7">(token, </span><span style="color:#6CB6FF">paste0</span><span style="color:#ADBAC7">(salt, session_token))</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p><code>validate_session_jwt</code> throws an error if the token is invalid.</p>
<hr>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">set_token</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(session, </span><span style="color:#F69D50">salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">)) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  token_obj </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> generate_session_jwt</span><span style="color:#ADBAC7">(session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">token, salt)</span></span>
<span data-line=""><span style="color:#ADBAC7">  session</span><span style="color:#F47067">$</span><span style="color:#F69D50">sendCustomMessage</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"token"</span><span style="color:#ADBAC7">, token_obj)</span></span>
<span data-line=""><span style="color:#ADBAC7">  token_obj</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p><code>set_token</code> function generates a token for the current session and sends it to the browser as a cookie. Naturally, we need to add a corresponding custom message handler to the UI:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">add_token_handler</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">() {</span></span>
<span data-line=""><span style="color:#ADBAC7">  tags</span><span style="color:#F47067">$</span><span style="color:#F69D50">script</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"</span></span>
<span data-line=""><span style="color:#96D0FF">      import 'https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js';</span></span>
<span data-line=""><span style="color:#96D0FF">      Shiny.addCustomMessageHandler('token', function({key, token}) {</span></span>
<span data-line=""><span style="color:#96D0FF">        Cookies.set(key, token);</span></span>
<span data-line=""><span style="color:#96D0FF">      })</span></span>
<span data-line=""><span style="color:#96D0FF">    "</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#F69D50">    type</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "module"</span></span>
<span data-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p>The handler receives a token and a key and stores them in the browser as a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">cookie</a> (using <code>js-cookie</code> library).</p>
<blockquote>
<p>One issue that remains is that the cookie lacks the <code>httpOnly</code> attribute (indicating that the cookie should not be accessible via JavaScript), leaving it vulnerable to theft via Cross-Site Scripting (XSS) attacks. Naturally, this is expected since we’re setting the cookie with JavaScript</p>
</blockquote>
<hr>
<p>Last but not least:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-language="r" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">parse_cookies</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(cookie_string) {</span></span>
<span data-line=""><span style="color:#ADBAC7">  cookies </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> strsplit</span><span style="color:#ADBAC7">(cookie_string, </span><span style="color:#96D0FF">";"</span><span style="color:#ADBAC7">)[[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">]]</span></span>
<span data-line=""><span style="color:#6CB6FF">  Reduce</span><span style="color:#ADBAC7">(</span><span style="color:#F47067">function</span><span style="color:#ADBAC7">(prev, curr) {</span></span>
<span data-line=""><span style="color:#ADBAC7">    cookie </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> strsplit</span><span style="color:#ADBAC7">(curr, </span><span style="color:#96D0FF">'='</span><span style="color:#ADBAC7">)[[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">]]</span></span>
<span data-line=""><span style="color:#ADBAC7">    key </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> trimws</span><span style="color:#ADBAC7">(cookie[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">])</span></span>
<span data-line=""><span style="color:#ADBAC7">    value </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> trimws</span><span style="color:#ADBAC7">(cookie[</span><span style="color:#6CB6FF">2</span><span style="color:#ADBAC7">])</span></span>
<span data-line=""><span style="color:#ADBAC7">    prev[[key]] </span><span style="color:#F47067">&#x3C;-</span><span style="color:#ADBAC7"> value</span></span>
<span data-line=""><span style="color:#ADBAC7">    prev</span></span>
<span data-line=""><span style="color:#ADBAC7">  }, cookies, </span><span style="color:#F69D50">init</span><span style="color:#F47067"> =</span><span style="color:#F47067"> list</span><span style="color:#ADBAC7">())</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span></code></pre></figure>
<p><code>parse_cookies</code> is used in the <code>filterFunc</code> to extract the token from the request and returns a named list of cookies.</p>
<p>The final code looks like this:</p>
<figure data-rehype-pretty-code-figure=""><figcaption data-rehype-pretty-code-title="" data-language="r" data-theme="github-dark-dimmed">app_3.r</figcaption><pre style="background-color:#22272e;color:#adbac7" tabindex="0" data-language="r" data-theme="github-dark-dimmed"><code data-line-numbers="" data-language="r" data-theme="github-dark-dimmed" style="display: grid;" data-line-numbers-max-digits="3"><span data-line=""><span style="color:#6CB6FF">library</span><span style="color:#ADBAC7">(shiny)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">library</span><span style="color:#ADBAC7">(jose)</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">Sys.setenv</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">SHINY_SALT</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> 'salt&#x26;pepper'</span><span style="color:#ADBAC7">)</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">generate_session_jwt</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    session_token,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">))</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">{</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">  modified_session_token</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> paste0</span><span style="color:#ADBAC7">(salt, session_token);</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  key </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> paste0</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'session_'</span><span style="color:#ADBAC7">,</span><span style="color:#6CB6FF">digest</span><span style="color:#F47067">::</span><span style="color:#F69D50">digest</span><span style="color:#ADBAC7">(modified_session_token))</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  token </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> jwt_encode_hmac</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">secret</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> modified_session_token)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F47067">  list</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    key</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> key,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    token</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> token</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">validate_session_jwt</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    token,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    session_token,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">  jwt_decode_hmac</span><span style="color:#ADBAC7">(token, </span><span style="color:#6CB6FF">paste0</span><span style="color:#ADBAC7">(salt, session_token))</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">add_token_handler</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">() {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  tags</span><span style="color:#F47067">$</span><span style="color:#F69D50">script</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#96D0FF">      import 'https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js';</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#96D0FF">      Shiny.addCustomMessageHandler('token', function({key, token}) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#96D0FF">        Cookies.set(key, token);</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#96D0FF">      })</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#96D0FF">    "</span><span style="color:#ADBAC7">,</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">    type</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "module"</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">set_token</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(session, </span><span style="color:#F69D50">salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">)) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  token_obj </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> generate_session_jwt</span><span style="color:#ADBAC7">(session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">token, salt)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  session</span><span style="color:#F47067">$</span><span style="color:#F69D50">sendCustomMessage</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"token"</span><span style="color:#ADBAC7">, token_obj)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  token_obj</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line="" data-highlighted-line=""> </span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">parse_cookies</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(cookie_string) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  cookies </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> strsplit</span><span style="color:#ADBAC7">(cookie_string, </span><span style="color:#96D0FF">";"</span><span style="color:#ADBAC7">)[[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">]]</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">  Reduce</span><span style="color:#ADBAC7">(</span><span style="color:#F47067">function</span><span style="color:#ADBAC7">(prev, curr) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    cookie </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> strsplit</span><span style="color:#ADBAC7">(curr, </span><span style="color:#96D0FF">'='</span><span style="color:#ADBAC7">)[[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">]]</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    key </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> trimws</span><span style="color:#ADBAC7">(cookie[</span><span style="color:#6CB6FF">1</span><span style="color:#ADBAC7">])</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    value </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> trimws</span><span style="color:#ADBAC7">(cookie[</span><span style="color:#6CB6FF">2</span><span style="color:#ADBAC7">])</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    prev[[key]] </span><span style="color:#F47067">&#x3C;-</span><span style="color:#ADBAC7"> value</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">    prev</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  }, cookies, </span><span style="color:#F69D50">init</span><span style="color:#F47067"> =</span><span style="color:#F47067"> list</span><span style="color:#ADBAC7">())</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">ui </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> fluidPage</span><span style="color:#ADBAC7">(</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">  add_token_handler</span><span style="color:#ADBAC7">(),</span></span>
<span data-line=""><span style="color:#F69D50">  textOutput</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"link"</span><span style="color:#ADBAC7">),</span></span>
<span data-line=""><span style="color:#F69D50">  uiOutput</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">"pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">)</span></span>
<span data-line=""> </span>
<span data-line=""> </span>
<span data-line=""><span style="color:#DCBDFB">server</span><span style="color:#F47067"> &#x3C;-</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(input, output, session) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">  token_obj </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> set_token</span><span style="color:#ADBAC7">(session)</span></span>
<span data-line=""><span style="color:#ADBAC7">  example_get_data_url </span><span style="color:#F47067">&#x3C;-</span><span style="color:#ADBAC7"> session</span><span style="color:#F47067">$</span><span style="color:#F69D50">registerDataObj</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#F69D50">    name</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "example-get-api"</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#F69D50">    data</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> {</span></span>
<span data-line=""><span style="color:#768390">      # Fetch the example PDF content from the external link and save it as a temporary file</span></span>
<span data-line=""><span style="color:#ADBAC7">      temp_pdf_path </span><span style="color:#F47067">&#x3C;-</span><span style="color:#6CB6FF"> tempfile</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">fileext</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> ".pdf"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#ADBAC7">      external_pdf_link </span><span style="color:#F47067">&#x3C;-</span><span style="color:#96D0FF"> 'https://www.africau.edu/images/default/sample.pdf'</span></span>
<span data-line=""><span style="color:#6CB6FF">      download.file</span><span style="color:#ADBAC7">(external_pdf_link, temp_pdf_path, </span><span style="color:#F69D50">mode</span><span style="color:#F47067"> =</span><span style="color:#96D0FF"> "wb"</span><span style="color:#ADBAC7">)</span></span>
<span data-line=""><span style="color:#6CB6FF">      readBin</span><span style="color:#ADBAC7">(temp_pdf_path, </span><span style="color:#96D0FF">"raw"</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">file.info</span><span style="color:#ADBAC7">(temp_pdf_path)</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">size)</span></span>
<span data-line=""><span style="color:#ADBAC7">    },</span></span>
<span data-line=""><span style="color:#DCBDFB">    filterFunc</span><span style="color:#F47067"> =</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(content, req) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#6CB6FF">      tryCatch</span><span style="color:#ADBAC7">({</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">        token </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> parse_cookies</span><span style="color:#ADBAC7">(req</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">HTTP_COOKIE)[[token_obj</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">key]]</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">        validate_session_jwt</span><span style="color:#ADBAC7">(token, session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">token, </span><span style="color:#F69D50">salt</span><span style="color:#F47067"> =</span><span style="color:#6CB6FF"> Sys.getenv</span><span style="color:#ADBAC7">(</span><span style="color:#96D0FF">'SHINY_SALT'</span><span style="color:#ADBAC7">))  </span><span style="color:#768390"># Throws an error if invalid</span></span>
<span data-line=""><span style="color:#F69D50">        httpResponse</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">200</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">"application/pdf"</span><span style="color:#ADBAC7">, content)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">      },</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#DCBDFB">      error</span><span style="color:#F47067"> =</span><span style="color:#F47067"> function</span><span style="color:#ADBAC7">(cond) {</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#F69D50">        httpResponse</span><span style="color:#ADBAC7">(</span><span style="color:#6CB6FF">403</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'text/plain'</span><span style="color:#ADBAC7">, </span><span style="color:#96D0FF">'not this time my friend'</span><span style="color:#ADBAC7">)</span></span>
<span data-line="" data-highlighted-line=""><span style="color:#ADBAC7">      })</span></span>
<span data-line=""><span style="color:#ADBAC7">    }</span></span>
<span data-line=""><span style="color:#ADBAC7">  )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">  output</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">pdf </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> renderUI</span><span style="color:#ADBAC7">(tags</span><span style="color:#F47067">$</span><span style="color:#F69D50">iframe</span><span style="color:#ADBAC7">(</span><span style="color:#F69D50">src</span><span style="color:#F47067"> =</span><span style="color:#ADBAC7"> example_get_data_url))</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#ADBAC7">  output</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">link </span><span style="color:#F47067">&#x3C;-</span><span style="color:#F69D50"> renderText</span><span style="color:#ADBAC7">({</span></span>
<span data-line=""><span style="color:#6CB6FF">    paste0</span><span style="color:#ADBAC7">(</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_protocol,</span></span>
<span data-line=""><span style="color:#96D0FF">      '//'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_hostname,</span></span>
<span data-line=""><span style="color:#96D0FF">      ':'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      session</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">clientData</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">url_port,</span></span>
<span data-line=""><span style="color:#96D0FF">      '/'</span><span style="color:#ADBAC7">,</span></span>
<span data-line=""><span style="color:#ADBAC7">      example_get_data_url</span></span>
<span data-line=""><span style="color:#ADBAC7">    )</span></span>
<span data-line=""><span style="color:#ADBAC7">  })</span></span>
<span data-line=""><span style="color:#ADBAC7">  </span></span>
<span data-line=""><span style="color:#768390">  # read pdf from https://www.africau.edu/images/default/sample.pdf</span></span>
<span data-line=""><span style="color:#ADBAC7">  pdfPath </span><span style="color:#F47067">&#x3C;-</span><span style="color:#96D0FF"> 'https://www.africau.edu/images/default/sample.pdf'</span></span>
<span data-line=""><span style="color:#6CB6FF">  readBin</span><span style="color:#ADBAC7">(pdfPath, </span><span style="color:#96D0FF">"raw"</span><span style="color:#ADBAC7">, </span><span style="color:#6CB6FF">file.info</span><span style="color:#ADBAC7">(pdfPath)</span><span style="color:#F47067">$</span><span style="color:#ADBAC7">size)</span></span>
<span data-line=""><span style="color:#ADBAC7">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F69D50">shinyApp</span><span style="color:#ADBAC7">(ui, server)</span></span></code></pre></figure>
<p>Now, try to open the link in a separate incognito tab. If you see error 403 (or a ‘not this time my friend’ message 😁) it means that the token is invalid 👉 we’re good to go!
<img alt="app_3"  src="/assets/asset.4BXDtO_E_Z2VEMt.webp" width="1140" height="496" loading="lazy" decoding="async"></p>
<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>
<p>In conclusion, this post delved into the security challenges linked with serving assets in Shiny apps and presented effective mitigation strategies.
The least secure method, utilizing <code>addResourcePath</code>, opens the door to unrestricted access to assets. A more robust alternative is establishing a dedicated endpoint within Shiny, limiting asset access to specific sessions.</p>
<p>However, a security gap persists in this approach, as a leaked link could be exploited by unauthorized users. This issue is currently under consideration in an open <a href="https://github.com/rstudio/shiny/pull/3766">Pull Request</a>. Until the proposed changes are incorporated, we can address this vulnerability by implementing a system that utilizes JSON Web Tokens (JWTs) to generate session access tokens. This final solution markedly improves security, rendering a leaked asset link insufficient for unauthorized data retrieval. Thus, we ensure that assets are exclusively served for the duration of a specific session to the browser that initiated it.</p> </section> </main> <footer class="text-sm leading-[1.75] mt-4" data-astro-cid-sz7xmlte> <p client:visible data-astro-cid-sz7xmlte>
All rights reserved © Filip Akkad 2024 </p> </footer>   </body> </html>